@startuml MemFlow Component Diagram

!theme plain
skinparam componentStyle rectangle
skinparam backgroundColor #FFFFFF
skinparam shadowing false

title MemFlow - Component Interaction Flow (Updated with Async Queue)

' Define components with colors
skinparam component {
    BackgroundColor<<UI>> #E3F2FD
    BorderColor<<UI>> #1976D2
    BackgroundColor<<API>> #FFF3E0
    BorderColor<<API>> #F57C00
    BackgroundColor<<Queue>> #FFF9C4
    BorderColor<<Queue>> #F57F17
    BackgroundColor<<Engine>> #E8F5E9
    BorderColor<<Engine>> #388E3C
    BackgroundColor<<Storage>> #F3E5F5
    BorderColor<<Storage>> #7B1FA2
}

actor User

package "Frontend (Flutter)" <<UI>> {
    component [Login Screen] as Login
    component [Dashboard Screen] as Dashboard
    component [Upload Screen] as Upload
    component [Operations Screen] as Operations
    component [Reports Screen] as Reports
    component [Upload API Routes] as UploadRoutes
    component [Dashboard API Routes] as DashRoutes
    component [Case Repository] as FrontRepo
}

package "Backend (Flask)" <<API>> {
    component [Upload API] as UploadAPI
    component [Status API] as StatusAPI
    component [Report API] as ReportAPI
    component [List Cases API] as ListAPI
    component [Case Controller] as CaseCtrl
    component [File Handler] as FileHandler
}

package "Task Queue System" <<Queue>> {
    component [Redis Queue] as Queue
    component [RQ Worker] as Worker
    component [analyze_memory_dump] as AnalyzeTask
}

package "Analysis Engine (CLI)" <<Engine>> {
    component [Memflow Analyzer] as Analyzer
    component [Format Detector] as FormatDet
    component [OS Detector] as OSDet
    component [Volatility Runner] as VolRunner
    component [Report Generator] as ReportGen
}

database "PostgreSQL" <<Storage>> {
    component [Cases Table] as CasesDB
    component [Files Table] as FilesDB
}

storage "File System" <<Storage>> {
    folder [Memory Dumps] as Dumps
    folder [Analysis Reports] as Reports
}

cloud "External" {
    component [Volatility3] as Vol3
    component [Redis Server] as Redis
}

' User authentication and navigation
User --> Login : 1. Authenticate
Login --> Dashboard : 2. Navigate after login
Dashboard --> DashRoutes : 3. Load cases
DashRoutes --> ListAPI : 4. GET /api/cases/

' Upload flow
Dashboard --> Upload : 5. Navigate to upload
Upload --> UploadRoutes : 6. Select file
UploadRoutes --> FrontRepo : 7. Upload case
FrontRepo --> UploadAPI : 8. POST /api/cases/upload\n(multipart/form-data)

UploadAPI --> CaseCtrl : 9. Create case
CaseCtrl --> CasesDB : 10. INSERT case\n(status='queued')
CaseCtrl --> FileHandler : 11. Process file
FileHandler --> Dumps : 12. Save memory dump
FileHandler --> FilesDB : 13. INSERT file record

' Async job queuing (NEW)
CaseCtrl ..> Queue : 14. Enqueue analysis job\n(async)
Queue --> Redis : 15. Store job in Redis

' Worker picks up job (NEW)
Worker --> Redis : 16. Poll for jobs
Worker --> AnalyzeTask : 17. Execute task
AnalyzeTask --> CasesDB : 18. UPDATE status\n='processing'

' Analysis flow
AnalyzeTask --> Analyzer : 19. Run analysis
Analyzer --> FormatDet : 20. Detect dump format
FormatDet --> Dumps : 21. Read file header
Analyzer --> OSDet : 22. Detect OS type
OSDet --> Dumps : 23. Scan for signatures
Analyzer --> VolRunner : 24. Run plugins
VolRunner --> Vol3 : 25. Execute volatility\ncommands
Vol3 --> Dumps : 26. Analyze memory
Vol3 --> VolRunner : 27. Return results
VolRunner --> ReportGen : 28. Parse output
ReportGen --> Reports : 29. Generate JSON report
ReportGen --> CasesDB : 30. UPDATE status\n='completed'
ReportGen --> FilesDB : 31. UPDATE report_path

' Status polling
Dashboard --> Operations : 32. Navigate to operations
Operations --> FrontRepo : 33. Poll for status
FrontRepo --> StatusAPI : 34. GET /api/cases/{id}/status
StatusAPI --> CasesDB : 35. Query case status
CasesDB --> StatusAPI : 36. Return status
StatusAPI --> FrontRepo : 37. JSON response
FrontRepo --> Operations : 38. Update UI

' Report retrieval
Operations --> FrontRepo : 39. Request report
FrontRepo --> ReportAPI : 40. GET /api/cases/{id}/report
ReportAPI --> Reports : 41. Read report file
Reports --> ReportAPI : 42. Report data
ReportAPI --> FrontRepo : 43. JSON response
FrontRepo --> Operations : 44. Display results

' View all reports
Dashboard --> Reports : 45. Navigate to reports
Reports --> FrontRepo : 46. Get all reports
FrontRepo --> ListAPI : 47. GET /api/cases/\n?status=completed

note right of Queue
    **Redis Queue (RQ)**
    - Async job processing
    - Decouples upload from analysis
    - Allows background processing
    - Job status tracking
end note

note right of Worker
    **RQ Worker Process**
    - Polls Redis queue
    - Executes analysis tasks
    - Updates case status
    - Handles failures gracefully
end note

note right of UploadAPI
    **Upload Endpoint**
    - Validates file type
    - Generates unique case ID
    - Calculates SHA-256 checksum
    - Enqueues analysis job
    - Returns immediately
end note

note right of Analyzer
    **Analysis Modes**
    - Quick: Format + OS detection
    - Essential: Basic plugins
    - Standard: Network analysis
    - Advanced: Malware detection
    - Full: Complete analysis
end note

note bottom of Vol3
    **Volatility3 Plugins**
    Windows: pslist, netscan, malfind
    Linux: bash, pslist, sockstat
    macOS: pslist, netstat, lsmod
end note

legend right
    |= Flow Type |= Description |
    | Solid line --> | Synchronous call |
    | Dotted line ..> | Asynchronous/queued |
    
    **Status Values:**
    queued → processing → completed/failed
    
    **New Components:**
    - Redis Queue for async processing
    - RQ Worker for background jobs
    - Login authentication
    - Dedicated upload screen
endlegend

@enduml